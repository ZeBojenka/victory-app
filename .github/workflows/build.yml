name: Build APK
on: [push]
jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 40
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get purge -y containerd* docker* || true
        sudo apt-get autoremove -y
        
        sudo apt-get install -y \
          build-essential \
          unzip \
          openjdk-17-jdk \
          git \
          autoconf \
          libtool \
          pkg-config \
          zlib1g-dev \
          libncurses5-dev \
          libncursesw5-dev \
          libtinfo5 \
          cmake \
          libffi-dev \
          libssl-dev \
          python3-dev \
          python3-venv \
          ffmpeg
        
    - name: Set up Python environment
      run: |
        python3 -m venv venv
        source venv/bin/activate
        pip install --upgrade pip wheel setuptools
        
    - name: Install Python dependencies
      run: |
        source venv/bin/activate
        pip install cython buildozer plyer kivy
        pip install "setuptools<67.0"
        pip install git+https://github.com/kivy/python-for-android.git@master
        
    - name: Configure audio file
      run: |
        # Convert audio to compatible format
        ffmpeg -i victory.wav -acodec pcm_s16le -ar 44100 -ac 1 victory_fixed.wav
        mv victory_fixed.wav victory.wav
        
    - name: Create buildozer.spec
      run: |
        cat <<EOF > buildozer.spec
        [app]
        title = VictoryApp
        package.name = victoryapp
        package.domain = org.example
        source.dir = .
        source.include_exts = py,wav
        version = 1.0
        requirements = python3,kivy==2.1.0,plyer,setuptools,cython
        orientation = portrait
        fullscreen = 0
        android.permissions = INTERNET
        android.api = 34
        android.minapi = 21
        android.ndk = 23b
        android.arch = armeabi-v7a
        android.allow_backup = False
        p4a.branch = master
        EOF
        
    - name: Build APK
      run: |
        source venv/bin/activate
        export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
        export PATH=$JAVA_HOME/bin:$PATH
        
        # Create necessary directories
        mkdir -p .buildozer/android/platform/python-for-android
        mkdir -p bin
        
        buildozer android clean
        buildozer -v android debug
        
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: victory-app
        path: bin/*.apk
        retention-days: 1
